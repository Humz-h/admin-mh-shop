<div class="product-management">
  <!-- Back to Dashboard Button -->
  <div class="back-navigation">
    <button class="btn btn-secondary" (click)="goBack()">
      ‚Üê Quay l·∫°i Dashboard
    </button>
  </div>

  <!-- Main Card Container -->
  <div class="main-card">
    <!-- Card Header -->
    <div class="card-header">
      <div class="card-header-content">
        <h2 class="card-title">Products List</h2>
        <p class="card-subtitle">Track your store's progress to boost your sales.</p>
      </div>
      <div class="card-header-actions">
        <button class="btn btn-export" (click)="exportProducts()" title="Xu·∫•t d·ªØ li·ªáu">
          <span class="btn-icon">üì•</span>
          Export
        </button>
        <button class="btn btn-primary" (click)="openAddProductModal()">
          <span class="btn-icon">+</span>
          Add Product
        </button>
      </div>
    </div>

    <!-- Search and Filter Bar -->
    <div class="search-filter-bar">
      <div class="search-box">
        <span class="search-icon">üîç</span>
        <input 
          type="text" 
          placeholder="Search..." 
          [(ngModel)]="searchTerm"
          (input)="onSearchInput()"
          class="search-input">
      </div>
      <button class="btn btn-filter" (click)="toggleFilterPanel()" title="B·ªô l·ªçc">
        <span class="btn-icon">‚öôÔ∏è</span>
        Filter
      </button>
    </div>

    <!-- Filter Dropdowns (Hidden by default, shown when filter panel is open) -->
    <div class="filter-panel" *ngIf="showFilterPanel">
      <div class="filter-controls">
        <select [(ngModel)]="selectedCategory" (change)="filterProducts()" class="filter-select">
          <option value="">T·∫•t c·∫£ danh m·ª•c</option>
          <option value="ƒêi·ªán t·ª≠">ƒêi·ªán t·ª≠</option>
          <option value="ƒêi·ªán gia d·ª•ng">ƒêi·ªán gia d·ª•ng</option>
          <option value="Th·ªùi trang">Th·ªùi trang</option>
          <option value="S√°ch">S√°ch</option>
          <option value="Gia d·ª•ng">Gia d·ª•ng</option>
        </select>
        <select [(ngModel)]="sortBy" (change)="sortProducts()" class="filter-select">
          <option value="name">S·∫Øp x·∫øp theo t√™n</option>
          <option value="price">S·∫Øp x·∫øp theo gi√°</option>
          <option value="stock">S·∫Øp x·∫øp theo t·ªìn kho</option>
          <option value="date">S·∫Øp x·∫øp theo ng√†y t·∫°o</option>
        </select>
      </div>
    </div>

    <!-- Loading State -->
    <div class="loading-container" *ngIf="isLoading && !showSkeleton">
      <div class="loading-spinner"></div>
      <p>ƒêang t·∫£i danh s√°ch s·∫£n ph·∫©m...</p>
    </div>

    <!-- Skeleton Loading -->
    <div class="skeleton-container" *ngIf="showSkeleton">
      <div class="skeleton-table">
        <div class="skeleton-header">
          <div class="skeleton-cell" *ngFor="let i of [1,2,3,4,5,6,7]"></div>
        </div>
        <div class="skeleton-row" *ngFor="let i of [1,2,3,4,5,6,7,8,9,10]">
          <div class="skeleton-cell skeleton-image"></div>
          <div class="skeleton-cell skeleton-text"></div>
          <div class="skeleton-cell skeleton-badge"></div>
          <div class="skeleton-cell skeleton-price"></div>
          <div class="skeleton-cell skeleton-badge"></div>
          <div class="skeleton-cell skeleton-date"></div>
          <div class="skeleton-cell skeleton-actions"></div>
        </div>
      </div>
    </div>

    <!-- Error State -->
    <div class="error-container" *ngIf="error && !isLoading">
      <div class="error-message">
        <span class="error-icon">‚ö†Ô∏è</span>
        <p>{{ error }}</p>
        <button class="btn btn-primary" (click)="loadProducts()">Th·ª≠ l·∫°i</button>
      </div>
    </div>

    <!-- Products Table -->
    <div class="table-container" *ngIf="!isLoading && !error && !showSkeleton">
    <table class="products-table">
      <thead>
        <tr>
          <th class="checkbox-column">
            <input type="checkbox" class="select-all-checkbox" (change)="toggleSelectAll($event)">
          </th>
          <th class="sortable" (click)="sortByColumn('name')">
            S·∫£n ph·∫©m
            <span class="sort-icon" *ngIf="currentSortColumn === 'name'">
              {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
            </span>
            <span class="sort-icon placeholder" *ngIf="currentSortColumn !== 'name'">‚Üë</span>
          </th>
          <th class="sortable" (click)="sortByColumn('category')">
            Danh m·ª•c
            <span class="sort-icon" *ngIf="currentSortColumn === 'category'">
              {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
            </span>
            <span class="sort-icon placeholder" *ngIf="currentSortColumn !== 'category'">‚Üë</span>
          </th>
          <th class="sortable" (click)="sortByColumn('brand')">
            Th∆∞∆°ng hi·ªáu
            <span class="sort-icon" *ngIf="currentSortColumn === 'brand'">
              {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
            </span>
            <span class="sort-icon placeholder" *ngIf="currentSortColumn !== 'brand'">‚Üë</span>
          </th>
          <th class="sortable" (click)="sortByColumn('price')">
            Gi√°
            <span class="sort-icon" *ngIf="currentSortColumn === 'price'">
              {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
            </span>
            <span class="sort-icon placeholder" *ngIf="currentSortColumn !== 'price'">‚Üë</span>
          </th>
          <th class="sortable" (click)="sortByColumn('stock')">
            T·ªìn kho
            <span class="sort-icon" *ngIf="currentSortColumn === 'stock'">
              {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
            </span>
            <span class="sort-icon placeholder" *ngIf="currentSortColumn !== 'stock'">‚Üë</span>
          </th>
          <th class="sortable" (click)="sortByColumn('date')">
            Ng√†y t·∫°o
            <span class="sort-icon" *ngIf="currentSortColumn === 'date'">
              {{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}
            </span>
            <span class="sort-icon placeholder" *ngIf="currentSortColumn !== 'date'">‚Üë</span>
          </th>
          <th class="actions-column"></th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let product of filteredProducts; trackBy: trackByProductId">
          <td class="checkbox-column">
            <input type="checkbox" class="product-checkbox" [checked]="isProductSelected(product)" (change)="toggleProductSelection(product, $event)">
          </td>
          <td class="product-cell">
            <div class="product-info">
              <img 
                [src]="getProductImage(product)" 
                [alt]="product.name" 
                class="product-thumbnail"
                loading="lazy"
                (error)="onImageError($event)">
              <span class="product-name">{{ product.name }}</span>
            </div>
          </td>
          <td class="category-cell">
            <span class="category-text">{{ getCategoryName(product.category) }}</span>
          </td>
          <td class="brand-cell">
            <span class="brand-text">{{ getProductBrand(product) }}</span>
          </td>
          <td class="price-cell">
            <span class="price">{{ formatCurrency(product.salePrice || product.price) }}</span>
          </td>
          <td class="stock-cell">
            <span class="stock-badge" [class.in-stock]="product.stock > 0" [class.out-of-stock]="product.stock === 0">
              {{ product.stock > 0 ? 'C√≤n h√†ng' : 'H·∫øt h√†ng' }}
            </span>
          </td>
          <td class="date-cell">
            {{ product.createdAt | date:'dd MMM, yyyy' }}
          </td>
          <td class="actions-cell">
            <button class="menu-button" (click)="toggleActionMenu(product.id)" title="T√πy ch·ªçn">
              <span class="menu-icon">‚ãØ</span>
            </button>
            <div class="action-menu" *ngIf="activeMenuId === product.id">
              <button class="menu-item" (click)="editProduct(product); closeActionMenu()">
                Ch·ªânh s·ª≠a
              </button>
              <button class="menu-item" (click)="viewProduct(product); closeActionMenu()">
                Xem
              </button>
              <button class="menu-item delete" (click)="deleteProduct(product); closeActionMenu()">
                X√≥a
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
    </div>
  </div>

  <!-- Load More Button -->
  <div class="load-more-container" *ngIf="currentPage < totalPages && !isLoading && !error && !showSkeleton">
    <button 
      class="btn btn-secondary load-more-btn" 
      (click)="loadMoreProducts()"
      [disabled]="isLoadingMore">
      <span *ngIf="!isLoadingMore">T·∫£i th√™m s·∫£n ph·∫©m</span>
      <span *ngIf="isLoadingMore">ƒêang t·∫£i...</span>
    </button>
  </div>

  <!-- Pagination -->
  <div class="pagination-container" *ngIf="totalPages > 1">
    <div class="pagination">
      <button 
        class="pagination-btn" 
        [disabled]="currentPage === 1"
        (click)="goToPage(currentPage - 1)">
        ‚Äπ
      </button>
      
      <button 
        *ngFor="let page of getPageNumbers()" 
        class="pagination-btn"
        [class.active]="page === currentPage"
        (click)="goToPage(page)">
        {{ page }}
      </button>
      
      <button 
        class="pagination-btn" 
        [disabled]="currentPage === totalPages"
        (click)="goToPage(currentPage + 1)">
        ‚Ä∫
      </button>
    </div>
    
    <div class="pagination-info">
      Hi·ªÉn th·ªã {{ (currentPage - 1) * itemsPerPage + 1 }} - 
      {{ Math.min(currentPage * itemsPerPage, filteredProducts.length) }} 
      trong {{ filteredProducts.length }} s·∫£n ph·∫©m
    </div>
  </div>

  <!-- Add/Edit Product Modal -->
  <app-product-insert-edit 
    [showModal]="showModal"
    [isEditing]="isEditing"
    [selectedProduct]="selectedProduct"
    (modalClosed)="onModalClosed()"
    (productSaved)="onProductSaved($event)">
  </app-product-insert-edit>
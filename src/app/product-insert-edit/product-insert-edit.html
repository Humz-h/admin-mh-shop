<!-- Product Insert/Edit Modal -->
<div class="modal-overlay" *ngIf="showModal" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ isEditing ? 'Ch·ªânh s·ª≠a s·∫£n ph·∫©m' : 'Th√™m s·∫£n ph·∫©m m·ªõi' }}</h2>
      <button class="modal-close" (click)="closeModal()">√ó</button>
    </div>
    
    <form class="product-form" #productForm="ngForm" (ngSubmit)="onSaveProductClick($event)">
      <!-- Success/Error Messages -->
      <div class="form-messages" *ngIf="saveSuccess || saveError">
        <div class="message success" *ngIf="saveSuccess">
          <span class="message-icon">‚úÖ</span>
          {{ saveSuccess }}
        </div>
        <div class="message error" *ngIf="saveError">
          <span class="message-icon">‚ùå</span>
          {{ saveError }}
        </div>
      </div>
      
      <!-- Modal Body with Two Columns -->
      <div class="modal-body">
        <!-- Left Column - Image Upload and QR Code -->
        <div class="left-column">
          <!-- Image Upload Section -->
          <div class="image-section">
            <label for="productImage">H√¨nh ·∫£nh s·∫£n ph·∫©m</label>
            
            <!-- Image Upload Area -->
            <div class="image-upload-area" (click)="triggerFileInput()" [class.has-image]="previewImageUrl || product.imageUrl">
              <input 
                type="file" 
                id="productImage"
                accept="image/*"
                (change)="onFileSelected($event)"
                class="file-input"
                #fileInput>
              
              <!-- Upload Placeholder -->
              <div class="upload-placeholder" *ngIf="!previewImageUrl && !product.imageUrl">
                <div class="upload-icon">
                  <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7,10 12,15 17,10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                  </svg>
                </div>
                <p class="upload-text">Click ƒë·ªÉ upload ·∫£nh</p>
                <p class="upload-specs">·∫¢nh ph·∫£i c√≥ t·ª∑ l·ªá vu√¥ng (1:1)<br>
                K√≠ch th∆∞·ªõc t·ªëi thi·ªÉu: 400x400px<br>
                Khuy·∫øn ngh·ªã: 800x800px<br>
                Dung l∆∞·ª£ng t·ªëi ƒëa: 2MB</p>
              </div>
              
              <!-- Image Preview -->
              <div class="image-preview" *ngIf="previewImageUrl">
                <img 
                  [src]="previewImageUrl" 
                  [alt]="product.name || 'Preview'"
                  class="preview-image">
                <div class="image-overlay">
                  <button type="button" class="remove-btn" (click)="removeImage($event)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                  <button type="button" class="change-btn" (click)="triggerFileInput($event)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                      <polyline points="7,10 12,15 17,10"></polyline>
                      <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
            
            <!-- File Info -->
            <div class="file-info" *ngIf="selectedFile">
              <span class="file-name">{{ selectedFile.name }}</span>
              <span class="file-size">({{ formatFileSize(selectedFile.size) }})</span>
            </div>
            
            <!-- Upload Button -->
            <div class="upload-actions" *ngIf="selectedFile">
              <button 
                type="button" 
                class="btn btn-primary btn-upload" 
                (click)="uploadImage()"
                [disabled]="isUploading">
                <span *ngIf="isUploading" class="loading-spinner-small"></span>
                {{ isUploading ? 'ƒêang upload...' : 'T·∫£i ·∫£nh l√™n' }}
              </button>
            </div>
            
            <!-- Upload Status -->
            <div class="upload-status" *ngIf="uploadError">
              <div class="message error">
                <span class="message-icon">‚ùå</span>
                {{ uploadError }}
              </div>
            </div>
          </div>
        </div>
        
        <!-- Right Column - Product Form -->
        <div class="right-column">
      
      <!-- Basic Product Information -->
      <div class="form-section">
        <h3 class="section-title">Th√¥ng tin c∆° b·∫£n</h3>
        
        <!-- Row 1: T√™n s·∫£n ph·∫©m -->
        <div class="form-row-single">
          <div class="form-group">
            <label for="productName">T√™n s·∫£n ph·∫©m *</label>
            <input 
              type="text" 
              id="productName"
              [(ngModel)]="product.name" 
              name="productName"
              required
              minlength="2"
              class="form-input"
              placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m"
              (input)="generateProductCodeFromName()"
              [class.error]="productForm.controls['productName']?.invalid && productForm.controls['productName']?.touched">
            <div class="field-error" *ngIf="productForm.controls['productName']?.invalid && productForm.controls['productName']?.touched">
              <span *ngIf="productForm.controls['productName']?.errors?.['required']">T√™n s·∫£n ph·∫©m l√† b·∫Øt bu·ªôc</span>
              <span *ngIf="productForm.controls['productName']?.errors?.['minlength']">T√™n s·∫£n ph·∫©m ph·∫£i c√≥ √≠t nh·∫•t 2 k√Ω t·ª±</span>
            </div>
          </div>
        </div>
        
        <!-- Row 2: Nh√≥m s·∫£n ph·∫©m, M√£ s·∫£n ph·∫©m, Danh m·ª•c -->
        <div class="form-row-triple">
          <div class="form-group">
            <label for="productGroup">Nh√≥m s·∫£n ph·∫©m</label>
            <input 
              type="text" 
              id="productGroup"
              [(ngModel)]="product.productGroup" 
              name="productGroup"
              class="form-input"
              placeholder="Nh·∫≠p nh√≥m s·∫£n ph·∫©m">
          </div>
          <div class="form-group">
            <label for="productCode">M√£ s·∫£n ph·∫©m</label>
            <input 
              type="text" 
              id="productCode"
              [(ngModel)]="product.productCode" 
              name="productCode"
              readonly
              class="form-input readonly-input"
              placeholder="T·ª± ƒë·ªông sinh t·ª´ t√™n s·∫£n ph·∫©m">
          </div>
          <div class="form-group">
            <label for="productCategory">Danh m·ª•c *</label>
            <select 
              id="productCategory"
              [(ngModel)]="product.category" 
              name="productCategory"
              required
              class="form-select">
              <option value="">Ch·ªçn danh m·ª•c</option>
              <option value="ƒêi·ªán t·ª≠">ƒêi·ªán t·ª≠</option>
              <option value="ƒêi·ªán gia d·ª•ng">ƒêi·ªán gia d·ª•ng</option>
              <option value="Th·ªùi trang">Th·ªùi trang</option>
              <option value="S√°ch">S√°ch</option>
              <option value="Gia d·ª•ng">Gia d·ª•ng</option>
            </select>
          </div>
        </div>
        
        <!-- Row 3: Gi√° g·ªëc, Ph·∫ßn trƒÉm khuy·∫øn m√£i, Gi√° b√°n -->
        <div class="form-row-triple">
          <div class="form-group">
            <label for="originalPrice">Gi√° g·ªëc (VND)</label>
            <input 
              type="number" 
              id="originalPrice"
              [(ngModel)]="product.originalPrice" 
              name="originalPrice"
              min="0"
              class="form-input"
              placeholder="Nh·∫≠p gi√° g·ªëc"
              (input)="calculateSalePrice()">
          </div>
          <div class="form-group">
            <label for="discountPercentage">Ph·∫ßn trƒÉm khuy·∫øn m√£i (%)</label>
            <input 
              type="number" 
              id="discountPercentage"
              [(ngModel)]="discountPercentage" 
              name="discountPercentage"
              min="0"
              max="100"
              step="0.01"
              class="form-input"
              placeholder="Nh·∫≠p % khuy·∫øn m√£i"
              (input)="calculateSalePrice()">
          </div>
          <div class="form-group">
            <label for="productPrice">Gi√° b√°n (VND) *</label>
            <input 
              type="number" 
              id="productPrice"
              [(ngModel)]="product.price" 
              name="productPrice"
              required
              min="1"
              readonly
              class="form-input readonly-input"
              placeholder="T·ª± ƒë·ªông t√≠nh">
            <div class="field-error" *ngIf="productForm.controls['productPrice']?.invalid && productForm.controls['productPrice']?.touched">
              <span *ngIf="productForm.controls['productPrice']?.errors?.['required']">Gi√° s·∫£n ph·∫©m l√† b·∫Øt bu·ªôc</span>
              <span *ngIf="productForm.controls['productPrice']?.errors?.['min']">Gi√° ph·∫£i l·ªõn h∆°n 0</span>
            </div>
          </div>
        </div>
        
        <!-- Row 4: T·ªìn kho v√† Tr·∫°ng th√°i -->
        <div class="form-row">
          <div class="form-group">
            <label for="productStock">T·ªìn kho *</label>
            <input 
              type="number" 
              id="productStock"
              [(ngModel)]="product.stock" 
              name="productStock"
              required
              min="0"
              class="form-input"
              placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng t·ªìn kho"
              [class.error]="productForm.controls['productStock']?.invalid && productForm.controls['productStock']?.touched">
            <div class="field-error" *ngIf="productForm.controls['productStock']?.invalid && productForm.controls['productStock']?.touched">
              <span *ngIf="productForm.controls['productStock']?.errors?.['required']">S·ªë l∆∞·ª£ng t·ªìn kho l√† b·∫Øt bu·ªôc</span>
              <span *ngIf="productForm.controls['productStock']?.errors?.['min']">S·ªë l∆∞·ª£ng kh√¥ng ƒë∆∞·ª£c √¢m</span>
            </div>
          </div>
          <div class="form-group">
            <label for="productStatus">Tr·∫°ng th√°i *</label>
            <select 
              id="productStatus"
              [(ngModel)]="product.status" 
              name="productStatus"
              required
              class="form-select">
              <option [value]="true">Ho·∫°t ƒë·ªông</option>
              <option [value]="false">Kh√¥ng ho·∫°t ƒë·ªông</option>
            </select>
          </div>
        </div>
        
        <!-- Row 5: M√¥ t·∫£ s·∫£n ph·∫©m -->
        <div class="form-row-single">
          <div class="form-group">
            <label for="productDescription">M√¥ t·∫£ s·∫£n ph·∫©m</label>
            <textarea 
              id="productDescription"
              [(ngModel)]="product.description" 
              name="productDescription"
              rows="3"
              class="form-textarea"
              placeholder="Nh·∫≠p m√¥ t·∫£ chi ti·∫øt v·ªÅ s·∫£n ph·∫©m"></textarea>
          </div>
        </div>
      </div>

      <!-- Product Details Section -->
      <div class="form-section">
        <div class="section-header">
          <h3 class="section-title">Chi ti·∫øt s·∫£n ph·∫©m</h3>
          <button type="button" class="btn btn-small btn-primary" (click)="addProductDetail()">
            + Th√™m chi ti·∫øt
          </button>
        </div>
        
        <div class="details-container" *ngFor="let detail of productDetails; let i = index; trackBy: trackByIndex">
          <div class="detail-item">
            <div class="detail-header">
              <h4>Chi ti·∫øt {{ i + 1 }}</h4>
              <button type="button" class="btn-remove" (click)="removeProductDetail(i)" *ngIf="productDetails.length > 1">
                üóëÔ∏è
              </button>
            </div>
            
            <!-- Row 1: Th∆∞∆°ng hi·ªáu v√† Xu·∫•t x·ª© -->
            <div class="form-row">
              <div class="form-group">
                <label [for]="'brand_' + i">Th∆∞∆°ng hi·ªáu</label>
                <input 
                  type="text" 
                  [id]="'brand_' + i"
                  [(ngModel)]="detail.brand" 
                  [name]="'brand_' + i"
                  class="form-input"
                  placeholder="Nh·∫≠p th∆∞∆°ng hi·ªáu">
              </div>
              <div class="form-group">
                <label [for]="'origin_' + i">Xu·∫•t x·ª©</label>
                <input 
                  type="text" 
                  [id]="'origin_' + i"
                  [(ngModel)]="detail.origin" 
                  [name]="'origin_' + i"
                  class="form-input"
                  placeholder="Nh·∫≠p xu·∫•t x·ª©">
              </div>
            </div>
            
            <!-- Row 2: B·∫£o h√†nh v√† Th√¥ng s·ªë k·ªπ thu·∫≠t -->
            <div class="form-row">
              <div class="form-group">
                <label [for]="'warranty_' + i">B·∫£o h√†nh</label>
                <input 
                  type="text" 
                  [id]="'warranty_' + i"
                  [(ngModel)]="detail.warranty" 
                  [name]="'warranty_' + i"
                  class="form-input"
                  placeholder="V√≠ d·ª•: 12 th√°ng">
              </div>
              <div class="form-group">
                <label [for]="'specifications_' + i">Th√¥ng s·ªë k·ªπ thu·∫≠t</label>
                <textarea 
                  [id]="'specifications_' + i"
                  [(ngModel)]="detail.specifications" 
                  [name]="'specifications_' + i"
                  rows="2"
                  class="form-textarea"
                  placeholder="Nh·∫≠p th√¥ng s·ªë k·ªπ thu·∫≠t"></textarea>
              </div>
            </div>
            
            <!-- Row 3: T√≠nh nƒÉng v√† Th√¥ng tin b·ªï sung -->
            <div class="form-row">
              <div class="form-group">
                <label [for]="'features_' + i">T√≠nh nƒÉng</label>
                <textarea 
                  [id]="'features_' + i"
                  [(ngModel)]="detail.features" 
                  [name]="'features_' + i"
                  rows="2"
                  class="form-textarea"
                  placeholder="Nh·∫≠p c√°c t√≠nh nƒÉng n·ªïi b·∫≠t"></textarea>
              </div>
              <div class="form-group">
                <label [for]="'additionalInfo_' + i">Th√¥ng tin b·ªï sung</label>
                <textarea 
                  [id]="'additionalInfo_' + i"
                  [(ngModel)]="detail.additionalInfo" 
                  [name]="'additionalInfo_' + i"
                  rows="2"
                  class="form-textarea"
                  placeholder="Th√¥ng tin kh√°c"></textarea>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Product Variants Section -->
      <div class="form-section">
        <div class="section-header">
          <h3 class="section-title">Bi·∫øn th·ªÉ s·∫£n ph·∫©m</h3>
          <button type="button" class="btn btn-small btn-primary" (click)="addProductVariant()">
            + Th√™m bi·∫øn th·ªÉ
          </button>
        </div>
        
        <div class="variants-container" *ngFor="let variant of productVariants; let i = index; trackBy: trackByIndex">
          <div class="variant-item">
            <div class="variant-header">
              <h4>Bi·∫øn th·ªÉ {{ i + 1 }}</h4>
              <button type="button" class="btn-remove" (click)="removeProductVariant(i)" *ngIf="productVariants.length > 1">
                üóëÔ∏è
              </button>
            </div>
            
            <!-- Row 1: T√™n bi·∫øn th·ªÉ v√† Thu·ªôc t√≠nh -->
            <div class="form-row">
              <div class="form-group">
                <label [for]="'variantName_' + i">T√™n bi·∫øn th·ªÉ</label>
                <input 
                  type="text" 
                  [id]="'variantName_' + i"
                  [(ngModel)]="variant.variantName" 
                  [name]="'variantName_' + i"
                  class="form-input"
                  placeholder="V√≠ d·ª•: M√†u ƒë·ªè, Size L">
              </div>
              <div class="form-group">
                <label [for]="'variantAttributes_' + i">Thu·ªôc t√≠nh</label>
                <input 
                  type="text" 
                  [id]="'variantAttributes_' + i"
                  [(ngModel)]="variant.attributes" 
                  [name]="'variantAttributes_' + i"
                  class="form-input"
                  placeholder="V√≠ d·ª•: Color: Red, Size: L">
              </div>
            </div>
            
            <!-- Row 2: Gi√° bi·∫øn th·ªÉ v√† SKU bi·∫øn th·ªÉ -->
            <div class="form-row">
              <div class="form-group">
                <label [for]="'variantPrice_' + i">Gi√° bi·∫øn th·ªÉ</label>
                <input 
                  type="number" 
                  [id]="'variantPrice_' + i"
                  [(ngModel)]="variant.price" 
                  [name]="'variantPrice_' + i"
                  min="0"
                  class="form-input"
                  placeholder="Gi√° cho bi·∫øn th·ªÉ n√†y">
              </div>
              <div class="form-group">
                <label [for]="'variantSku_' + i">SKU bi·∫øn th·ªÉ</label>
                <input 
                  type="text" 
                  [id]="'variantSku_' + i"
                  [(ngModel)]="variant.sku" 
                  [name]="'variantSku_' + i"
                  class="form-input"
                  placeholder="SKU cho bi·∫øn th·ªÉ">
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Form Actions -->
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" (click)="closeModal()" [disabled]="isSaving">
          H·ªßy
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="isSaving">
          <span *ngIf="isSaving" class="loading-spinner-small"></span>
          {{ isSaving ? 'ƒêang l∆∞u...' : (isEditing ? 'C·∫≠p nh·∫≠t' : 'Th√™m m·ªõi') }}
        </button>
      </div>
        </div>
      </div>
    </form>
  </div>
</div>
